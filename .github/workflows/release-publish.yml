name: Release Publishing

on:
  workflow_call:
    inputs:
      phase:
        description: The release phase (publishing or close-issues)
        type: string
        required: true
      dry-run:
        description: Run in dry-run mode
        type: boolean
        default: false
      custom-registries:
        description: Custom npm registry base URLs (one per line)
        type: string
        required: false
    secrets:
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true
      ANTHROPIC_API_KEY:
        required: false
      CLAUDE_REVIEW_PAT:
        required: false
      CUSTOM_REGISTRY_TOKENS:
        required: false

jobs:
  publish:
    name: Publish Packages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup runtime
        id: runtime
        uses: savvy-web/workflow-runtime-action@main

      - name: Build registry URLs
        id: registries
        if: inputs.custom-registries != ''
        shell: bash
        env:
          REGISTRIES: ${{ inputs.custom-registries }}
          TOKENS: ${{ secrets.CUSTOM_REGISTRY_TOKENS }}
        run: |
          # Combine registry URLs with their corresponding tokens
          IFS=$'\n' read -r -d '' -a urls <<< "$REGISTRIES" || true
          IFS=$'\n' read -r -d '' -a tokens <<< "$TOKENS" || true

          result=""
          for i in "${!urls[@]}"; do
            url="${urls[$i]}"
            token="${tokens[$i]:-}"
            if [[ -n "$url" ]]; then
              result+="${url}/${token}"$'\n'
            fi
          done

          # Use heredoc delimiter to handle multiline output
          {
            echo "urls<<EOF"
            echo -n "$result"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Run release
        uses: savvy-web/workflow-release-action@main
        with:
          phase: ${{ inputs.phase }}
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-review-pat: ${{ secrets.CLAUDE_REVIEW_PAT }}
          dry-run: ${{ inputs.dry-run }}
          custom-registries: ${{ steps.registries.outputs.urls }}
